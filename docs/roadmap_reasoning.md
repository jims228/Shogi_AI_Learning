# Roadmap: Explainable Reasoning for Shogi Annotation

目的
- 将棋AI注釈アプリにおいて、エンジン評価（数値）を人間に分かりやすい「根拠（reasoning）」として言語化する設計指針を整理する。
- 将来的には Explainable AI の手法と将棋知識を組み合わせ、教育・研究・商用へ展開する。

概要
- 現状: エンジンは PV（Principal Variation）や評価値（score_cp）を返すが、なぜその手が良い/悪いかの説明は人の解釈に依存する。
- 目標: エンジン出力を意味構造に変換し、自然言語で「根拠」を自動生成し、UI と API で利用できる形にする。

ステップ構成
1. USI 出力から意味構造を抽出
   - エンジンの `info` 行や PV から、キーフィールド（評価変化、候補手、多PV、深さ、pv）を抽出するパイプラインを作る。
   - ルールベースで「駒損」「王手」「駒捌き」「攻めの継続」「受けの不足」などの候補タグを推論する初期モジュールを作成する。
   - 出力は構造化 JSON（例: { ply, move, before, after, delta_cp, tags:[], tactical: {...}, material: {...} }）に正規化する。

2. GPT（または類似の LLM）を使った自然言語の根拠生成
   - ステップ1の構造化データをプロンプト化して、モデルに短い根拠文（1〜2文）を生成させる。
   - 温度や出力トークン量を制御し、堅牢で一貫性の高いフォーマット（例: JSON lines / 構造化出力）を得られるようテンプレート化する。
   - LLM による創発的誤り（hallucination）対策として、必ず元データ（PV・スコア・捕獲フラグ等）への参照を含めさせる。

3. JSON 出力に `reasoning` フィールドを追加
   - API レスポンス（`/annotate`, `/digest` など）に `reasoning` フィールドを追加する拡張を提案。
   - 例: `notes[i].reasoning = { summary: "攻めが続く", evidence: [{type:'pv', value:'7g7f 3c3d'}, {type:'delta_cp', value:+120}] , text: "この手は..." }`
   - `reasoning` は複数レベル（短文 summary / 詳細 evidence / raw model output）を含める。

4. UI で根拠を可視化（駒利き・形勢変化のハイライト）
   - 将棋盤上で根拠に対応する手順（PV）をハイライト。特に評価の急変があった局面は視覚的にマーキング。
   - サイドバーに「短い根拠」→「詳しい根拠（証拠付き）」を折りたたみ式で表示。
   - ユーザが根拠に対してフィードバック（いいね / 編集）を行えるようにし、将来的な教師データにする。

商用展開アイデア
- API として「Explainable Annotation」機能を提供（課金ベース）
- 将棋ウォーズ等のオンライン対局ログを解析してワークショップ向けの「棋譜解説サービス」を提供
- プロ棋士のコメントを取り込み、注釈の品質を高めたプレミアム版を提供

研究展開
- Explainable AI の解釈可能性指標を将棋に適用（忠実性・一貫性・説明可能性の評価指標の定義）
- プロ棋士コメントとの教師学習による LLM のファインチューニング（評価値→根拠の整合性向上）
- モデルの不確実性（confidence）を評価し、信頼できる根拠のみ UI に出す設計

短期ロードマップ（3ヶ月）
- 1st month: USI パーサとルールベース tagger を実装し、構造化 JSON を返す API を作る
- 2nd month: LLM プロンプト設計と安全策（参照強制、生成テンプレート）を実装し、`reasoning.text` を返す実装
- 3rd month: UI の表示改善（ハイライト、フィードバック）と内部評価指標の収集

長期ビジョン（6〜12ヶ月）
- プロの棋士データと対比した品質評価、モデル改良サイクル確立
- サブスクリプション/API プロダクト化、教育向け機能の追加（段位別チューニング）

コミット目的
- 「数字を言葉にする」方向性をチームで共有し、次の開発イテレーションの優先順位決定を助ける。

付録: 初期フォーマット例（notes[i] の拡張）
```json
{
  "ply": 12,
  "move": "7g7f",
  "score_before_cp": -30,
  "score_after_cp": +90,
  "delta_cp": 120,
  "tags": ["好手","駒取り"],
  "reasoning": {
    "summary": "駒得と王手の継続により形勢が大きく改善",
    "evidence": [
      {"type":"pv","value":"7g7f 3c3d 7f7e"},
      {"type":"delta_cp","value":120}
    ],
    "text": "7g7f は駒取りを伴い、相手の王周辺を露呈させるため評価が大幅に改善しました。"
  }
}
```

---

このドキュメントは初版です。実装を進める中で、評価指標やプロンプト、UI 表現などを逐次更新していきましょう。
